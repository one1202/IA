目的
- `Flow chart for IA.png` のフローに沿って、基礎的な Java コードを IB シラバスに沿った擬似コードへ変換する JS ツールを構築する。
- Java ソースを受け取り、正規化し、トークン化し、反復的に AST を構築・検証し、プレオーダー走査で擬似コードを出力する。
- スコープ外の入力（例: OOP、2 次元配列、不正な構文）は拒否する。

成功基準
- 対応する構造: 変数宣言/代入、算術/関係/論理式、if/else、while/do-while/for ループ、入れ子の制御フロー、1 次元配列、`main` 相当 1 つに限定した単純なメソッド（必要最小限のラッパークラスのみ）、コメント/空白。
- 未対応構造に対して明確なエラーメッセージで明示的に失敗する（ラッパーを超えるクラス、オブジェクト/OOP、インターフェース、2 次元配列、例外、ジェネリクス、ラムダ、`java.lang` 以外の import、単純な `System.out/Scanner` を超える I/O、switch、try/catch）。
- 正規化/トークン化は決定的で空白や書式に依存しない。
- AST ビルダーが構文エラーを検知し、最初の致命的な問題で停止する。
- 擬似コード出力は IB スタイルの書式（大文字小文字、一貫したインデント、キーワード）に従い、制御構造を正確に反映する。
- 走査はプレオーダーで行い、出力順は AST の訪問順に一致する。
- エラーと出力は構造化され、機械的に検証可能。

詳細 TODO
- 入力と検証
  - Java ソースを文字列/ファイルで受け付け、BOM を除去し、文字コード (UTF-8) を強制する。
  - サイズ上限を事前検証し、空入力を拒否し、位置情報付きでエラーを提示する。
  - スコープガードを追加: 許可されないトークン/キーワード（`main` ラッパーを超えるクラス定義、`try`、`switch`、`new`、ジェネリクス `< >`、`[][]` を含む配列など）を走査し、発見次第エラーで打ち切る。
- 正規化
  - 行末記号を統一し、タブをスペースに変換し、行/列対応を維持したまま余分な空白を畳み込む。
  - コメント (`//`, `/* */`) と文字列を除去/記録し、位置保持のためにプレースホルダーを残す。
  - リテラルを正規化（例: boolean/int/float の表記ゆれを統一）し、キーワードの大文字小文字を Java の規則に揃える。
  - エラー報告用に、元のオフセットへのマッピング付きの正規化済みソースを生成する。
- トークン化
  - 識別子、リテラル、演算子、句読点、キーワード、区切りのトークン型を定義する。
  - 行/列情報付きのトークン列を出す DFA または正規表現ベースのトークナイザーを実装する。
  - 優先順位を考慮した演算子の分割に対応する（`==`, `!=`, `<=`, `>=`, `&&`, `||`, `++`, `--`, `+=` など）。
  - 位置と理由付きで字句エラーを出し、未対応トークンを拒否する。
- AST 構築（フローに従い反復）
  - 対応サブセットの式と文をカバーする再帰下降または Pratt パーサーを実装する。
  - 文法規則を厳守: 宣言/代入、if/else、while・do-while・for（基本形）、ブロック `{}`、単純な `main` ラッパー、1 次元配列の宣言/アクセス、入れ子の制御フロー。
  - 未対応の文法に遭遇したらスコープ付きエラーを出して停止する。
  - 型付きの種別、子ノード、ソース範囲を持つ AST ノードを構築し、走査用に親リンクを保持する。
  - トークン列を消費し尽くすまでノード生成を反復/前進し、エラー時も同期を確保する。
- AST 走査と擬似コード生成
  - プレオーダー走査を実装する。
  - ノード種別を IB スタイルの擬似コードテンプレートにマッピングする（例: `IF <cond> THEN`, `ELSE`, `END IF`; `FOR i FROM <start> TO <end> STEP <step>`; `WHILE <cond> DO`; 代入; 宣言; 配列アクセス）。
  - インデントと改行を一貫管理し、入れ子ブロックに対応する。
  - Java の演算子を擬似コードの同等表現に置換する（`&&` → `AND`, `||` → `OR`, `!` → `NOT`, `==` → `=` など）。
  - スコープ内であれば正規化時に収集したコメントを任意で出力し、それ以外は落とす。
- エラーハンドリング
  - エラー形式を集約: `{stage, message, line, column, snippet?}`。
  - スコープ外構造で即座に失敗し、行動可能なメッセージを返す。
  - 致命的エラー後は（フローチャートに従い）後続ステージを実行しない。
- インターフェースと I/O
  - シンプルな API を提供: `convert(javaSource: string): { pseudocode?: string, errors?: Error[] }`。
  - 手動実行用の CLI ラッパーを追加（`node ./IA.js <file>`）し、エラー/擬似コードを明瞭に出力する。
- 非目標 / スコープ外
  - OOP 機能（最小限のラッパーを超えるクラス）、`main` 以外のメソッド、2 次元配列、switch、例外、ジェネリクス、ラムダ/streams、デフォルト以外の import、複雑な I/O。

テスト計画
- ユニットテスト
  - 正規化: 位置保持、コメント除去、空白正規化。
  - トークナイザー: 代表的スニペットのトークン列; 不正トークンでのエラー。
  - パーサー: 宣言、代入、if/else、while/do-while/for、入れ子ブロック、1 次元配列アクセスの AST 構築; スコープ外構造の正しいエラー。
  - 擬似コード生成: 各ノード種別の正しいマッピング; インデントと演算子変換; 走査がプレオーダーであること。
- 統合テスト
  - ハッピーパス: 各対応構造と入れ子を含む小規模プログラム; 混在する制御フロー; 配列。
  - エラーケース: OOP 利用、2 次元配列、switch、try/catch、未対応演算子、構文不正。
  - 書式耐性: 多様な空白、コメント、改行。
- ゴールデンファイル
  - Java 入力 → 期待する擬似コードのフィクスチャ対を管理し、テストで差分を確認する。
- CLI テスト
  - 終了コードの確認: 成功時 0、エラー時非 0; stderr/stdout の分離; 明瞭なメッセージ。

前提 / 未確定事項
- IB 擬似コード方言: 標準的な IB DP スタイル（IF/ELSE/END IF, WHILE DO/END WHILE, FOR FROM TO STEP など）を前提とする。より厳密な形式が必要な場合はキーワードの大文字小文字や行末の仕様を定義する。
- 入力は単一の `class` と `main` に包まれている想定。より深いクラス/メソッド構造はスコープ外としてエラーにする。
